<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple POS</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; }
    header { padding: 12px 16px; background: #111; color: #fff; }
    .wrap { padding: 12px 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .col { flex: 1; min-width: 200px; }
    input, select, button, textarea { font-size: 16px; padding: 10px; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; }
    .grid { display: grid; gap: 8px; }
    .cart { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .cart th, .cart td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
    .cart td.num, .cart th.num { text-align: right; }
    .sticky-bar { position: sticky; bottom: 0; background: #fff; border-top: 1px solid #eee; padding: 12px 16px; }
    .pill { padding: 6px 10px; background: #f3f4f6; border-radius: 999px; }
    .scanbox { position: relative; background: #000; border-radius: 8px; overflow: hidden; }
    video { width: 100%; height: auto; }
    .overlay { position: absolute; inset: 0; box-shadow: inset 0 0 0 2px rgba(255,255,255,.5); pointer-events: none; }
    .badge { font-size: 12px; opacity: .8; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div class="col"><strong id="storeNameView">My Store</strong></div>
      <div class="col" style="text-align:right"><span class="badge">POS Web</span></div>
    </div>
  </header>

  <div class="wrap grid" id="app">

    <!-- Config Panel -->
    <details>
      <summary>Settings</summary>
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div><label>Store name<input id="storeName" /></label></div>
        <div><label>Cashier name<input id="cashier" /></label></div>
        <div><label>Currency symbol<input id="currency" value="₱" /></label></div>
        <div><label>Tax rate (%)<input id="taxRate" type="number" step="0.01" value="0" /></label></div>
        <div style="grid-column: 1 / -1;"><label>Google Apps Script Web App URL<input id="webhook" placeholder="https://script.google.com/macros/s/AKfycbyVOcVKgkqEfpD9j2F_UDFEdq0_ROS7zpqNR-tBFaqsHGdJ35cxz74j-0Msi3tZEpNM/exec" /></label></div>
        <div style="grid-column: 1 / -1;"><label>Notes<textarea id="notes" rows="2" placeholder="Optional notes printed to sheet"></textarea></label></div>
        <div><button id="saveSettings">Save settings</button></div>
      </div>
    </details>

    <!-- Scanner & manual add -->
    <div class="grid" style="grid-template-columns: 1fr;">
      <div class="scanbox">
        <video id="video" playsinline></video>
        <div class="overlay"></div>
      </div>
      <div class="row">
        <div class="col"><input id="barcodeInput" placeholder="Scan or type barcode" autocomplete="off" /></div>
        <div class="col"><input id="nameInput" placeholder="Item name (optional)" /></div>
        <div class="col"><input id="priceInput" type="number" step="0.01" placeholder="Unit price" /></div>
        <div style="width:140px"><button id="addItem">Add</button></div>
      </div>
      <div class="row">
        <span class="pill" id="scanStatus">Scanner: initializing…</span>
      </div>
    </div>

    <!-- Cart table -->
    <table class="cart" id="cartTable">
      <thead>
        <tr>
          <th>Barcode</th>
          <th>Name</th>
          <th class="num">Qty</th>
          <th class="num">Unit</th>
          <th class="num">Discount</th>
          <th class="num">Line Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="cartBody"></tbody>
    </table>

    <!-- Totals + Checkout -->
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
      <div><label>Cash received<input id="cash" type="number" step="0.01" /></label></div>
      <div><label>Subtotal<input id="subtotal" disabled /></label></div>
      <div><label>Tax<input id="tax" disabled /></label></div>
      <div><label>Grand Total<input id="grand" disabled /></label></div>
      <div><label>Change<input id="change" disabled /></label></div>
      <div style="grid-column: 1 / -1; display:flex; gap:8px;">
        <button id="clearCart">Clear Cart</button>
        <button id="submitSale">Submit to Google Sheet</button>
      </div>
    </div>
  </div>

  <!-- ZXing fallback (optional CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const state = {
      items: [],
      settings: {
        storeName: localStorage.getItem('storeName') || 'My Store',
        cashier: localStorage.getItem('cashier') || '',
        currency: localStorage.getItem('currency') || '₱',
        taxRate: parseFloat(localStorage.getItem('taxRate') || '0'),
        webhook: localStorage.getItem('webhook') || '',
        notes: localStorage.getItem('notes') || ''
      }
    };

    function saveSettings() {
      state.settings.storeName = $('storeName').value.trim() || 'My Store';
      state.settings.cashier = $('cashier').value.trim();
      state.settings.currency = $('currency').value || '₱';
      state.settings.taxRate = parseFloat($('taxRate').value || '0') || 0;
      state.settings.webhook = $('webhook').value.trim();
      state.settings.notes = $('notes').value.trim();
      for (const k in state.settings) localStorage.setItem(k, state.settings[k]);
      render();
      alert('Settings saved.');
    }

    function money(n){ return state.settings.currency + (Number(n)||0).toFixed(2); }

    function addItem(barcode, name, unitPrice, qty=1, discount=0) {
      unitPrice = Number(unitPrice)||0; qty = Number(qty)||1; discount = Number(discount)||0;
      const lineTotal = Math.max(0, qty * unitPrice - discount);
      state.items.push({ barcode, name, qty, unitPrice, lineDiscount: discount, lineTotal });
      render();
    }

    function updateItem(idx, patch) {
      const it = state.items[idx];
      Object.assign(it, patch);
      it.qty = Math.max(1, Number(it.qty)||1);
      it.unitPrice = Math.max(0, Number(it.unitPrice)||0);
      it.lineDiscount = Math.max(0, Number(it.lineDiscount)||0);
      it.lineTotal = Math.max(0, it.qty * it.unitPrice - it.lineDiscount);
      render();
    }

    function removeItem(idx) { state.items.splice(idx,1); render(); }

    function computeTotals() {
      const subtotal = state.it
